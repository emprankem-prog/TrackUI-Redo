{% extends "layout.html" %}

{% block title %}{{ user.display_name or user.username }} - TrackUI{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-header">
    <!-- Avatar -->
    {% if user.profile_picture %}
    <img src="{{ user.profile_picture }}" alt="{{ user.username }}" class="profile-avatar">
    {% else %}
    <div class="profile-avatar">
        {% if platform == 'instagram' %}üì∏{% elif platform == 'tiktok' %}üéµ{% else %}üíñ{% endif %}
    </div>
    {% endif %}

    <!-- Info -->
    <div class="profile-info">
        <h1 class="profile-name">{{ user.display_name or display_username }}</h1>
        <p class="profile-username">
            @{{ display_username }}
            <span class="user-card-platform" style="margin-left: 8px;">
                {% if platform == 'instagram' %}üì∏ Instagram
                {% elif platform == 'tiktok' %}üéµ TikTok
                {% else %}üíñ Coomer{% endif %}
            </span>
        </p>

        <!-- Tags -->
        <div class="user-card-tags" style="justify-content: flex-start; padding: 0; margin-top: 16px;">
            {% for tag in user.tags %}
            <span class="tag"
                style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}">
                {{ tag.name }}
            </span>
            {% endfor %}
        </div>

        <!-- Stats -->
        <div class="profile-stats" style="margin-top: 16px; justify-content: flex-start;">
            <div class="profile-stat">
                <div class="profile-stat-value">{{ media.posts | length }}</div>
                <div class="profile-stat-label">Posts</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value">{{ media.stories | length }}</div>
                <div class="profile-stat-label">Stories</div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="profile-actions">
        <button class="btn btn-feed btn-lg" onclick="openFeedViewer(0)">
            üì± Open Feed
        </button>
        <button class="btn btn-primary btn-lg" onclick="syncUser({{ user.id }}, '{{ user.username }}')">
            üîÑ Sync Now
        </button>
        <a href="/" class="btn btn-secondary">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>



<!-- Media Type Filter -->
<div class="media-filter">
    <button class="filter-btn active" data-filter="all" onclick="filterMedia('all')">
        üéØ All
    </button>
    <button class="filter-btn" data-filter="image" onclick="filterMedia('image')">
        üñºÔ∏è Images
    </button>
    <button class="filter-btn" data-filter="video" onclick="filterMedia('video')">
        üé¨ Videos
    </button>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab active" data-tab="posts" onclick="switchTab('posts')">
        üì∑ Posts ({{ media.posts | length }})
    </button>
    <button class="tab" data-tab="stories" onclick="switchTab('stories')">
        ‚è≥ Stories ({{ media.stories | length }})
    </button>
</div>

<!-- Posts Tab -->
<div id="tab-posts" class="tab-content active">
    {% if media.posts %}
    <div class="media-grid-fixed">
        {% for item in media.posts %}
        <div class="media-item-fixed"
            onclick="openMediaViewer('/media/{{ item.path }}/{{ item.filename }}', '{{ item.type }}')">
            {% if item.type == 'video' %}
            <video data-src="/media/{{ item.path }}/{{ item.filename }}" class="lazy-video" preload="none"
                muted></video>
            <div class="media-video-indicator">üé¨</div>
            {% else %}
            <img src="/media/{{ item.path }}/{{ item.filename }}" alt="" loading="lazy">
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üì∑</div>
        <h2 class="empty-state-title">No posts yet</h2>
        <p class="empty-state-description">Sync this user to download their posts.</p>
    </div>
    {% endif %}
</div>

<!-- Stories Tab -->
<div id="tab-stories" class="tab-content">
    {% if media.stories %}
    <div class="media-grid-fixed">
        {% for item in media.stories %}
        <div class="media-item-fixed"
            onclick="openMediaViewer('/media/{{ item.path }}/{{ item.filename }}', '{{ item.type }}')">
            {% if item.type == 'video' %}
            <video data-src="/media/{{ item.path }}/{{ item.filename }}" class="lazy-video" preload="none"
                muted></video>
            <div class="media-video-indicator">üé¨</div>
            {% else %}
            <img src="/media/{{ item.path }}/{{ item.filename }}" alt="" loading="lazy">
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <h2 class="empty-state-title">No stories yet</h2>
        <p class="empty-state-description">Stories will appear here when downloaded.</p>
    </div>
    {% endif %}
</div>



<script>

    // Media type filter
    let currentFilter = 'all';

    function filterMedia(type) {
        currentFilter = type;

        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === type);
        });

        // Filter all media grids
        document.querySelectorAll('.media-item-fixed').forEach(item => {
            const isVideo = item.querySelector('video') !== null;
            const itemType = isVideo ? 'video' : 'image';

            if (type === 'all' || itemType === type) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });

        // Also update feed media array for the feed viewer
        if (type === 'all') {
            feedMedia = isShuffled ? shuffleArray(allMediaOriginal) : [...allMediaOriginal];
        } else {
            const filtered = allMediaOriginal.filter(item => item.type === type);
            feedMedia = isShuffled ? shuffleArray(filtered) : filtered;
        }
    }

    // =========================================================================
    // TikTok-Style Feed Viewer
    // =========================================================================

    // All media items for feed (original order)
    const allMediaOriginal = [
        {% for item in media.posts %}
    { src: '/media/{{ item.path }}/{{ item.filename }}', type: '{{ item.type }}' },
    {% endfor %}
    ];

    let feedMedia = [...allMediaOriginal];
    let currentFeedIndex = 0;
    let isMuted = true;
    let isShuffled = false;

    // Fisher-Yates shuffle algorithm
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function toggleShuffle() {
        isShuffled = !isShuffled;
        const btn = document.getElementById('feed-shuffle-btn');
        btn.classList.toggle('active', isShuffled);

        if (isShuffled) {
            feedMedia = shuffleArray(allMediaOriginal);
            showToast('üîÄ Shuffle ON', 'success');
        } else {
            feedMedia = [...allMediaOriginal];
            showToast('üìã Original order', 'info');
        }

        // Rebuild feed with new order
        rebuildFeed();
    }

    function rebuildFeed() {
        const container = document.getElementById('feed-container');
        container.innerHTML = feedMedia.map((item, index) => `
            <div class="feed-item" data-index="${index}">
                ${item.type === 'video'
                ? `<video src="${item.src}" loop playsinline ${isMuted ? 'muted' : ''}></video>`
                : `<img src="${item.src}" alt="">`
            }
                <div class="feed-counter">${index + 1} / ${feedMedia.length}</div>
            </div>
        `).join('');

        currentFeedIndex = 0;
        scrollToFeedItem(0);
        setupFeedObserver();
    }

    function openFeedViewer(startIndex = 0, shuffle = false) {
        if (allMediaOriginal.length === 0) {
            showToast('No media to display', 'error');
            return;
        }

        // Apply shuffle if requested
        if (shuffle) {
            isShuffled = true;
            feedMedia = shuffleArray(allMediaOriginal);
            document.getElementById('feed-shuffle-btn').classList.add('active');
        } else if (!isShuffled) {
            feedMedia = [...allMediaOriginal];
        }

        currentFeedIndex = startIndex;
        const viewer = document.getElementById('feed-viewer');
        const container = document.getElementById('feed-container');

        // Build feed items
        container.innerHTML = feedMedia.map((item, index) => `
            <div class="feed-item" data-index="${index}">
                ${item.type === 'video'
                ? `<video src="${item.src}" loop playsinline ${isMuted ? 'muted' : ''}></video>`
                : `<img src="${item.src}" alt="">`
            }
                <div class="feed-counter">${index + 1} / ${feedMedia.length}</div>
            </div>
        `).join('');


        viewer.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Scroll to start index
        setTimeout(() => {
            scrollToFeedItem(startIndex);
        }, 50);

        // Setup intersection observer for auto-play
        setupFeedObserver();
    }

    function closeFeedViewer() {
        const viewer = document.getElementById('feed-viewer');
        viewer.classList.remove('active');
        document.body.style.overflow = '';

        // Pause all videos
        document.querySelectorAll('#feed-container video').forEach(v => {
            v.pause();
        });
    }

    function scrollToFeedItem(index) {
        const container = document.getElementById('feed-container');
        const items = container.querySelectorAll('.feed-item');
        if (items[index]) {
            items[index].scrollIntoView({ behavior: 'smooth', block: 'start' });
            currentFeedIndex = index;
        }
    }

    function toggleFeedMute() {
        isMuted = !isMuted;
        const muteBtn = document.getElementById('feed-mute-btn');
        muteBtn.textContent = isMuted ? 'üîá' : 'üîä';

        document.querySelectorAll('#feed-container video').forEach(v => {
            v.muted = isMuted;
        });
    }

    function setupFeedObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target.querySelector('video');
                if (video) {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                        video.play().catch(() => { });
                        currentFeedIndex = parseInt(entry.target.dataset.index);
                    } else {
                        video.pause();
                    }
                }
            });
        }, {
            root: document.getElementById('feed-container'),
            threshold: 0.5
        });

        document.querySelectorAll('.feed-item').forEach(item => {
            observer.observe(item);
        });
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        const viewer = document.getElementById('feed-viewer');
        if (!viewer.classList.contains('active')) return;

        if (e.key === 'Escape') {
            closeFeedViewer();
        } else if (e.key === 'ArrowDown' || e.key === ' ') {
            e.preventDefault();
            if (currentFeedIndex < allMedia.length - 1) {
                scrollToFeedItem(currentFeedIndex + 1);
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (currentFeedIndex > 0) {
                scrollToFeedItem(currentFeedIndex - 1);
            }
        } else if (e.key === 'm') {
            toggleFeedMute();
        }
    });
</script>

<!-- TikTok-Style Feed Viewer -->
<div id="feed-viewer" class="feed-viewer">
    <div class="feed-header">
        <button class="feed-close-btn" onclick="closeFeedViewer()">‚úï</button>
        <span class="feed-username">@{{ username }}</span>
        <div class="feed-header-actions">
            <button id="feed-shuffle-btn" class="feed-action-btn" onclick="toggleShuffle()" title="Shuffle">üîÄ</button>
            <button id="feed-mute-btn" class="feed-action-btn" onclick="toggleFeedMute()" title="Mute">üîá</button>
        </div>
    </div>
    <div id="feed-container" class="feed-container"></div>
    <div class="feed-nav">
        <button class="feed-nav-btn"
            onclick="if(currentFeedIndex > 0) scrollToFeedItem(currentFeedIndex - 1)">‚ñ≤</button>
        <button class="feed-nav-btn"
            onclick="if(currentFeedIndex < feedMedia.length - 1) scrollToFeedItem(currentFeedIndex + 1)">‚ñº</button>
    </div>
</div>

<style>
    /* TikTok-Style Feed Viewer */
    .feed-viewer {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 2000;
        display: none;
        flex-direction: column;
    }

    .feed-viewer.active {
        display: flex;
    }

    .feed-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        z-index: 10;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
    }

    .feed-header-actions {
        display: flex;
        gap: 12px;
    }

    .feed-close-btn,
    .feed-action-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        transition: all 0.2s;
    }

    .feed-close-btn:hover,
    .feed-action-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .feed-action-btn.active {
        background: linear-gradient(135deg, #fe2c55 0%, #25f4ee 100%);
        box-shadow: 0 0 15px rgba(254, 44, 85, 0.5);
    }

    .feed-username {
        color: white;
        font-size: 16px;
        font-weight: 600;
    }

    .feed-container {
        flex: 1;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .feed-container::-webkit-scrollbar {
        display: none;
    }

    .feed-item {
        height: 100vh;
        width: 100%;
        scroll-snap-align: start;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: #000;
    }

    .feed-item img,
    .feed-item video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .feed-counter {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        backdrop-filter: blur(10px);
    }

    .feed-nav {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 10;
    }

    .feed-nav-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        backdrop-filter: blur(10px);
        transition: all 0.2s;
    }

    .feed-nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    /* Open Feed Button */
    .btn-feed {
        background: linear-gradient(135deg, #fe2c55 0%, #25f4ee 100%);
        color: white;
        border: none;
    }

    .btn-feed:hover {
        box-shadow: 0 0 20px rgba(254, 44, 85, 0.4);
    }

    @media (max-width: 768px) {
        .feed-nav {
            display: none;
        }

        .feed-counter {
            bottom: 80px;
        }
    }

    /* Media Type Filter */
    .media-filter {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .filter-btn {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-btn:hover {
        border-color: var(--accent-primary);
        color: var(--text-primary);
    }

    .filter-btn.active {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: white;
    }
</style>
{% endblock %}