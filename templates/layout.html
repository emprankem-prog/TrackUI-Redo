<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TrackUI - Social Media Archiver & Tracker">
    <meta name="theme-color" content="#3b82f6">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="/static/style.css?v={{ range(1000000) | random }}">

    <!-- Theme Initialization (inline to prevent flash) -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            // Update button icon when DOM loads
            document.addEventListener('DOMContentLoaded', function () {
                const btn = document.getElementById('theme-toggle');
                if (btn) btn.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            });
        })();

        // Global toggle theme function
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const btn = document.getElementById('theme-toggle');
            if (btn) btn.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
    </script>

    <title>{% block title %}TrackUI{% endblock %}</title>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">
                <div class="logo-icon">üì¶</div>
                <span>TrackUI</span>
            </a>

            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openModal('add-user-modal')">
                    <span>‚ûï</span>
                    Add User
                </button>
                <button class="btn btn-secondary" onclick="openCreateGroupModal()">
                    <span>üë•</span>
                    Create Group
                </button>
                <button class="btn btn-secondary" onclick="openModal('import-following-modal')">
                    <span>üì•</span>
                    Import Following
                </button>
                <button class="btn btn-secondary" onclick="syncAllUsers()">
                    <span>üîÑ</span>
                    Sync All
                </button>
                <a href="/browse" class="btn btn-secondary">
                    <span>üìÇ</span>
                    Browse Files
                </a>
                <button class="btn btn-ghost btn-icon" onclick="randomUser()" title="Random User">
                    üé≤
                </button>
                <button class="btn btn-ghost btn-icon" onclick="openModal('tags-modal'); loadTags();" title="Tags">
                    üè∑Ô∏è
                </button>
                <button class="btn btn-ghost btn-icon" onclick="openModal('stats-modal'); loadStats();" title="Stats">
                    üìä
                </button>
                <button class="btn btn-ghost btn-icon" onclick="toggleTheme()" title="Toggle Theme" id="theme-toggle">
                    üåô
                </button>
                <button class="btn btn-ghost btn-icon"
                    onclick="openModal('settings-modal'); loadSettings(); loadCookies();" title="Settings">
                    ‚öôÔ∏è
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <!-- Floating Download Button -->
    <div class="floating-btn">
        <button class="btn btn-primary" onclick="openModal('downloads-modal')" title="Downloads">
            üì•
        </button>
        <span id="queue-badge" class="badge hidden">0</span>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop"></div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Add User</h3>
            <button class="modal-close" onclick="closeModal('add-user-modal')">‚úï</button>
        </div>
        <form onsubmit="addUser(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="add-platform">Platform</label>
                    <select id="add-platform" class="form-select" required onchange="toggleCoomerFields()">
                        <option value="">Select platform...</option>
                        <option value="instagram">üì∏ Instagram</option>
                        <option value="tiktok">üéµ TikTok</option>
                        <option value="coomer">üíñ Coomer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-username">Username</label>
                    <input type="text" id="add-username" class="form-input" placeholder="e.g. username123" required>
                </div>
                <div id="coomer-service-group" class="form-group hidden">
                    <label class="form-label" for="add-coomer-service">Service</label>
                    <select id="add-coomer-service" class="form-select">
                        <option value="onlyfans">OnlyFans</option>
                        <option value="fansly">Fansly</option>
                        <option value="candfans">CandFans</option>
                        <option value="fantia">Fantia</option>
                        <option value="gumroad">Gumroad</option>
                        <option value="patreon">Patreon</option>
                        <option value="subscribestar">SubscribeStar</option>
                    </select>
                    <p class="text-muted" style="font-size: 12px; margin-top: 4px;">
                        Select the service where this creator is hosted
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('add-user-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add User</button>
            </div>
        </form>
    </div>

    <!-- Import Following Modal -->
    <div id="import-following-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">üì• Import Instagram Following</h3>
            <button class="modal-close" onclick="closeModal('import-following-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <p class="text-muted mb-md">
                    Import users you follow on Instagram. Requires Instagram cookies to be set.
                </p>
                <button type="button" class="btn btn-primary btn-lg" id="fetch-following-btn" style="width: 100%;">
                    üîç Fetch My Following List
                </button>
            </div>

            <div id="following-status" class="hidden">
                <div class="settings-section">
                    <div class="flex items-center justify-between mb-md">
                        <h4 class="settings-section-title mb-0">Following List</h4>
                        <div class="flex gap-sm">
                            <button class="btn btn-secondary btn-sm" id="select-all-btn">Select All</button>
                            <button class="btn btn-secondary btn-sm" id="deselect-all-btn">Deselect All</button>
                        </div>
                    </div>
                    <div id="following-list" class="following-list">
                        <!-- Following users will be loaded here -->
                    </div>
                </div>
            </div>

            <div id="following-loading" class="hidden">
                <div class="flex items-center justify-center p-lg">
                    <div class="loading-spinner"></div>
                    <span class="ml-md">Fetching following list...</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary"
                onclick="closeModal('import-following-modal')">Cancel</button>
            <button type="button" class="btn btn-primary" id="import-selected-btn" disabled>
                Import Selected (<span id="selected-count">0</span>)
            </button>
        </div>
    </div>

    <!-- Downloads Modal -->
    <div id="downloads-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">Downloads</h3>
            <button class="modal-close" onclick="closeModal('downloads-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="queue-list" class="queue-list">
                <div class="queue-empty">
                    <p>üì≠ No downloads in queue</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="clearCompletedDownloads()">Clear Completed</button>
            <button type="button" class="btn btn-primary" onclick="openModal('external-download-modal')">Download
                URL</button>
        </div>
    </div>

    <!-- External Download Modal -->
    <div id="external-download-modal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Download External URL</h3>
            <button class="modal-close" onclick="closeModal('external-download-modal')">‚úï</button>
        </div>
        <form onsubmit="downloadExternalUrl(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="external-url">URL</label>
                    <input type="url" id="external-url" class="form-input" placeholder="https://..." required>
                    <p class="text-muted" style="font-size: 12px; margin-top: 4px;">
                        Supports GoFile, or any URL that gallery-dl can handle
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label" for="external-folder">Folder Name</label>
                    <input type="text" id="external-folder" class="form-input" placeholder="external" value="external">
                </div>
                <div class="form-group">
                    <label class="form-label" for="external-password">Password (optional)</label>
                    <input type="password" id="external-password" class="form-input"
                        placeholder="For password-protected GoFile links">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('external-download-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Download</button>
            </div>
        </form>
    </div>

    <!-- Tags Modal -->
    <div id="tags-modal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Manage Tags</h3>
            <button class="modal-close" onclick="closeModal('tags-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <form onsubmit="addTag(event)" class="mb-lg">
                <div class="flex gap-sm items-center">
                    <input type="text" id="tag-name" class="form-input" placeholder="Tag name" style="flex: 1;">
                    <input type="color" id="tag-color" value="#3b82f6"
                        style="width: 50px; height: 38px; border: none; border-radius: 6px; cursor: pointer;">
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
            <div id="tags-list" class="cookie-list">
                <p class="text-muted">Loading tags...</p>
            </div>
        </div>
    </div>

    <!-- Tag Assign Modal -->
    <div id="tag-assign-modal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Assign Tag</h3>
            <button class="modal-close" onclick="closeModal('tag-assign-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="stats-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">üìä Storage Statistics</h3>
            <button class="modal-close" onclick="closeModal('stats-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- Summary Cards -->
            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total-storage">--</div>
                    <div class="stat-label">Total Storage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-total-files">--</div>
                    <div class="stat-label">Total Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-total-users">--</div>
                    <div class="stat-label">Tracked Profiles</div>
                </div>
            </div>

            <!-- Platform Chart -->
            <div class="settings-section">
                <h4 class="settings-section-title">Storage by Platform</h4>
                <div id="platform-chart" class="platform-chart">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>

            <!-- Profile List -->
            <div class="settings-section">
                <h4 class="settings-section-title">Tracked Profiles</h4>
                <div id="stats-user-list" class="stats-user-list">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius-lg);
            padding: var(--space-lg);
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            margin-top: var(--space-xs);
        }

        .platform-chart {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .platform-bar {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .platform-bar-label {
            width: 100px;
            font-weight: 500;
        }

        .platform-bar-track {
            flex: 1;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
        }

        .platform-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }

        .platform-bar-fill.instagram {
            background: linear-gradient(90deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }

        .platform-bar-fill.tiktok {
            background: linear-gradient(90deg, #25f4ee, #fe2c55);
        }

        .platform-bar-fill.coomer {
            background: linear-gradient(90deg, #ff6b9d, #c44569);
        }

        .platform-bar-size {
            width: 80px;
            text-align: right;
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }

        .stats-user-list {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .stats-user-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--border-radius-md);
        }

        .stats-user-item:hover {
            background: var(--bg-elevated);
        }

        .stats-user-platform {
            font-size: 18px;
        }

        .stats-user-name {
            flex: 1;
            font-weight: 500;
        }

        .stats-user-files {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }

        .stats-user-size {
            font-weight: 600;
            color: var(--accent-primary);
        }
    </style>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">Settings</h3>
            <button class="modal-close" onclick="closeModal('settings-modal')">‚úï</button>
        </div>
        <form onsubmit="saveSettings(event)"
            style="display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: hidden;">
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <!-- Scheduler Settings -->
                <div class="settings-section">
                    <h4 class="settings-section-title">‚è∞ Auto-Sync Scheduler</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Enable Scheduler</div>
                            <div class="settings-description">Automatically sync all users on a schedule</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="scheduler-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Sync Time</div>
                        </div>
                        <input type="time" id="scheduler-time" class="form-input" style="width: auto;" value="03:00">
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Interval</div>
                        </div>
                        <select id="scheduler-interval" class="form-select" style="width: auto;">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly (Mondays)</option>
                        </select>
                    </div>
                </div>

                <!-- Download Settings -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üì• Downloads</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Max Concurrent Downloads</div>
                            <div class="settings-description">Number of downloads to run at the same time</div>
                        </div>
                        <select id="max-concurrent" class="form-select" style="width: auto;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Refresh Profile Avatars</div>
                            <div class="settings-description">Re-download all profile pictures</div>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshAvatars()">
                            üñºÔ∏è Refresh Avatars
                        </button>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üîê Security</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Password Protection</div>
                            <div class="settings-description">Lock the app with a password</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="password-enabled" onchange="togglePasswordFields()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="password-fields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="app-password">New Password</label>
                            <input type="password" id="app-password" class="form-input" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="app-password-confirm">Confirm Password</label>
                            <input type="password" id="app-password-confirm" class="form-input"
                                placeholder="Confirm password">
                        </div>
                        <button class="btn btn-primary" onclick="savePassword()">Set Password</button>
                        <button class="btn btn-secondary" onclick="removePassword()">Remove Password</button>
                    </div>

                    <!-- Auto-Lock -->
                    <div class="settings-row" style="margin-top: var(--space-md);">
                        <div>
                            <div class="settings-label">Auto-Lock</div>
                            <div class="settings-description">Lock app after inactivity (requires password)</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="auto-lock-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Lock After</div>
                        </div>
                        <select id="auto-lock-delay" class="form-select" style="width: auto;">
                            <option value="1">1 minute</option>
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                        </select>
                    </div>

                    <!-- Panic Button -->
                    <div class="settings-row" style="margin-top: var(--space-md);">
                        <div>
                            <div class="settings-label">Panic Button</div>
                            <div class="settings-description">Press <kbd>Esc</kbd> 3x quickly to lock & redirect</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="panic-button-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Notifications Settings -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üîî Notifications</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Enable Notifications</div>
                            <div class="settings-description">Send notifications when downloads complete</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="notifications-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Telegram -->
                    <div
                        style="margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--border-color);">
                        <div class="settings-label" style="margin-bottom: var(--space-sm);">üì± Telegram Bot</div>
                        <div class="form-group">
                            <input type="text" id="telegram-token" class="form-input"
                                placeholder="Bot Token (123456789:ABC...)">
                        </div>
                        <div class="form-group">
                            <input type="text" id="telegram-chat-id" class="form-input" placeholder="Chat ID">
                        </div>
                    </div>

                    <!-- Discord -->
                    <div
                        style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--border-color);">
                        <div class="settings-label" style="margin-bottom: var(--space-sm);">üí¨ Discord Webhook</div>
                        <div class="form-group">
                            <input type="text" id="discord-webhook-url" class="form-input"
                                placeholder="https://discord.com/api/webhooks/...">
                            <p class="text-muted" style="font-size: 12px; margin-top: 4px;">
                                Get this from Discord: Server Settings ‚Üí Integrations ‚Üí Webhooks
                            </p>
                        </div>
                        <button class="btn btn-secondary" onclick="testNotification()"
                            style="margin-top: var(--space-sm);">
                            üîî Test Notification
                        </button>
                    </div>
                </div>

                <!-- Auto-Retry Settings -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üîÑ Auto-Retry Downloads</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Enable Auto-Retry</div>
                            <div class="settings-description">Automatically retry failed downloads</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="retry-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-row" style="margin-top: var(--space-md);">
                        <div>
                            <div class="settings-label">Max Retry Attempts</div>
                        </div>
                        <select id="retry-max-attempts" class="form-select" style="width: auto;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Retry Delay</div>
                        </div>
                        <select id="retry-delay-seconds" class="form-select" style="width: auto;">
                            <option value="10">10 seconds</option>
                            <option value="30" selected>30 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="120">2 minutes</option>
                        </select>
                    </div>
                </div>

                <!-- TikTok Settings -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üéµ TikTok Settings</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Download Engine</div>
                            <div class="settings-description">Select which tool to use for downloads</div>
                        </div>
                        <select id="tiktok-engine" class="form-select" style="width: auto;">
                            <option value="gallery-dl">gallery-dl (Best for Images)</option>
                            <option value="yt-dlp">yt-dlp (Best for Videos)</option>
                        </select>
                    </div>
                </div>

                <!-- Encryption Settings -->
                <div class="settings-section" id="encryption-section">
                    <h4 class="settings-section-title">üîê Encryption</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Enable Encryption</div>
                            <div class="settings-description">Encrypt sensitive settings (tokens, webhook URLs)</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="encryption-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p class="text-muted" style="font-size: 12px; margin-top: var(--space-sm);" id="encryption-status">
                        Checking encryption availability...
                    </p>
                </div>

                <!-- Instagram Cookies -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üç™ Instagram Cookies</h4>
                    <div class="upload-zone" onclick="document.getElementById('cookie-upload').click()">
                        <div class="upload-zone-icon">üì§</div>
                        <p>Click to upload cookies.txt</p>
                        <input type="file" id="cookie-upload" accept=".txt" onchange="uploadCookie(event, 'instagram')">
                    </div>
                    <div id="cookies-list" class="cookie-list mt-md">
                        <p class="text-muted">Loading cookies...</p>
                    </div>
                </div>

                <!-- TikTok Cookies -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üéµ TikTok Cookies</h4>
                    <div class="upload-zone" onclick="document.getElementById('tiktok-cookie-upload').click()">
                        <div class="upload-zone-icon">üì§</div>
                        <p>Click to upload cookies.txt</p>
                        <input type="file" id="tiktok-cookie-upload" accept=".txt"
                            onchange="uploadCookie(event, 'tiktok')">
                    </div>
                    <div id="tiktok-cookies-list" class="cookie-list mt-md">
                        <p class="text-muted">Loading cookies...</p>
                    </div>
                </div>

                <!-- Audit Log -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üìã Audit Log</h4>
                    <p class="text-muted mb-md">Track all actions performed in the app</p>
                    <div class="flex gap-md">
                        <button type="button" class="btn btn-secondary"
                            onclick="openModal('audit-log-modal'); loadAuditLog();">
                            üìã View Log
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="exportAuditLog()">
                            üì• Export CSV
                        </button>
                        <button type="button" class="btn btn-danger" onclick="clearAuditLog()">
                            üóëÔ∏è Clear Old
                        </button>
                    </div>
                </div>

                <!-- Backup/Restore -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üíæ Backup & Restore</h4>
                    <div class="flex gap-md">
                        <button type="button" class="btn btn-secondary" onclick="downloadBackup()">
                            üì¶ Download Backup
                        </button>
                        <label class="btn btn-secondary" style="cursor: pointer;">
                            üì• Restore Backup
                            <input type="file" accept=".zip" onchange="restoreBackup(event)" style="display: none;">
                        </label>
                    </div>
                </div>

                <!-- Debug Mode -->
                <div class="settings-section">
                    <h4 class="settings-section-title">üêõ Developer Mode</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Enable Debug Mode</div>
                            <div class="settings-description">Show extra buttons on profile cards for debugging (refresh
                                avatar, etc.)</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="debug-mode-enabled" onchange="toggleDebugMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- TikTok Engine Selector (Debug Only) -->
                    <div class="settings-row debug-only" style="margin-top: var(--space-md);">
                        <div>
                            <div class="settings-label">TikTok Download Engine</div>
                            <div class="settings-description">Choose which downloader to use for TikTok</div>
                        </div>
                        <select id="tiktok-engine" class="form-select" style="width: auto;">
                            <option value="auto">Auto (yt-dlp)</option>
                            <option value="yt-dlp">yt-dlp only</option>
                            <option value="gallery-dl">gallery-dl only</option>
                        </select>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="settings-section danger-zone">
                    <h4 class="settings-section-title">‚ö†Ô∏è Danger Zone</h4>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Factory Reset</div>
                            <div class="settings-description">Delete all data and start fresh</div>
                        </div>
                        <button type="button" class="btn btn-danger" onclick="factoryReset()">
                            Reset
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('settings-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>

    <!-- Audit Log Modal -->
    <div id="audit-log-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">üìã Audit Log</h3>
            <button class="modal-close" onclick="closeModal('audit-log-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="flex gap-md mb-md" style="align-items: center;">
                <input type="text" id="audit-log-search" class="form-input" placeholder="Search logs..."
                    style="flex: 1;" oninput="filterAuditLog()">
                <select id="audit-log-filter" class="form-select" style="width: auto;" onchange="filterAuditLog()">
                    <option value="">All Actions</option>
                    <option value="user_added">User Added</option>
                    <option value="user_deleted">User Deleted</option>
                    <option value="user_archived">Archived</option>
                    <option value="download_completed">Download Completed</option>
                    <option value="download_failed">Download Failed</option>
                    <option value="download_retry">Download Retry</option>
                </select>
            </div>
            <div id="audit-log-list" class="audit-log-list" style="max-height: 400px; overflow-y: auto;">
                <p class="text-muted text-center">Loading...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="loadMoreAuditLogs()">Load More</button>
            <button type="button" class="btn btn-primary" onclick="closeModal('audit-log-modal')">Close</button>
        </div>
    </div>

    <!-- Media Viewer Modal -->
    <div id="media-viewer-modal" class="modal modal-xl">
        <div class="modal-header">
            <h3 class="modal-title">Media Viewer</h3>
            <button class="modal-close" onclick="closeMediaViewer()">‚úï</button>
        </div>
        <div class="modal-body" style="display: flex; justify-content: center; align-items: center; background: #000;">
            <div class="media-viewer-content"></div>
        </div>
    </div>

    <!-- Sync Confirmation Modal -->
    <div id="sync-confirm-modal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Sync Started</h3>
            <button class="modal-close" onclick="closeModal('sync-confirm-modal')">‚úï</button>
        </div>
        <div class="modal-body text-center">
            <div style="font-size: 48px; margin-bottom: 16px;">üöÄ</div>
            <p>Download has been added to the queue!</p>
            <p class="text-muted">Check the Downloads panel for progress.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary"
                onclick="closeModal('sync-confirm-modal'); openModal('downloads-modal');">
                View Downloads
            </button>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="create-group-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">üë• Create Profile Group</h3>
            <button class="modal-close" onclick="closeModal('create-group-modal')">‚úï</button>
        </div>
        <form onsubmit="createGroup(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="group-name">Group Name</label>
                    <input type="text" id="group-name" class="form-input" placeholder="e.g., John's Accounts" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Select Accounts (at least 2)</label>
                    <div id="group-user-list" class="user-select-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="form-group" id="avatar-picker-section" style="display: none;">
                    <label class="form-label">Choose Group Avatar</label>
                    <div id="avatar-picker" class="avatar-picker-grid">
                        <!-- Populated by JavaScript when users are selected -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('create-group-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Group</button>
            </div>
        </form>
    </div>

    <!-- Group Selector Modal -->
    <div id="group-selector-modal" class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="group-selector-title">Select Account</h3>
            <button class="modal-close" onclick="closeModal('group-selector-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <p class="text-muted" style="margin-bottom: 16px;">Choose which account to view:</p>
            <div id="group-members-list" class="group-members-list">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div id="edit-group-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">‚úèÔ∏è Edit Group</h3>
            <button class="modal-close" onclick="closeModal('edit-group-modal')">‚úï</button>
        </div>
        <form onsubmit="saveGroupEdit(event)">
            <input type="hidden" id="edit-group-id">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="edit-group-name">Group Name</label>
                    <input type="text" id="edit-group-name" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Members</label>
                    <div id="edit-group-user-list" class="user-select-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="form-group" id="edit-avatar-picker-section">
                    <label class="form-label">Choose Group Avatar</label>
                    <div id="edit-avatar-picker" class="avatar-picker-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('edit-group-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- First Time Setup Wizard -->
    <div id="setup-wizard-modal" class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title" id="setup-modal-title">üöÄ Welcome to TrackUI</h3>
        </div>
        <div class="modal-body">
            <!-- Step indicators -->
            <div class="setup-steps">
                <div class="setup-step active" data-step="1">1</div>
                <div class="setup-step" data-step="2">2</div>
                <div class="setup-step" data-step="3">3</div>
                <div class="setup-step" data-step="4">4</div>
                <div class="setup-step" data-step="5">5</div>
                <div class="setup-step" data-step="6">6</div>
            </div>

            <!-- Step 1: Welcome -->
            <div class="setup-content" id="setup-step-1">
                <div style="text-align: center; padding: var(--space-xl) 0;">
                    <div style="font-size: 72px; margin-bottom: var(--space-lg);">üì¶</div>
                    <h2 style="font-size: 28px; margin-bottom: var(--space-md);">Welcome to TrackUI</h2>
                    <p class="text-muted" style="font-size: 16px; max-width: 400px; margin: 0 auto;">
                        Your personal social media archiver for Instagram, TikTok, and Coomer content.
                    </p>
                    <p class="text-muted" style="margin-top: var(--space-lg);">
                        Let's get you set up in just a few steps!
                    </p>
                </div>
            </div>

            <!-- Step 2: Restore Backup -->
            <div class="setup-content hidden" id="setup-step-2">
                <h4>üì¶ Restore from Backup</h4>
                <p class="text-muted mb-md">Have a backup from a previous installation?</p>
                <div style="text-align: center; padding: var(--space-lg) 0;">
                    <label class="btn btn-primary btn-lg" style="cursor: pointer;">
                        üì• Restore Backup
                        <input type="file" id="setup-backup-file" accept=".zip" style="display: none;"
                            onchange="setupRestoreBackup(event)">
                    </label>
                    <p id="setup-backup-status" class="text-muted mt-md"></p>
                    <p class="text-muted mt-lg" style="font-size: 14px;">
                        Or continue to set up fresh ‚Üí
                    </p>
                </div>
            </div>

            <!-- Step 3: Password (was Step 1) -->
            <div class="setup-content hidden" id="setup-step-3">
                <h4>üîê Password Protection</h4>
                <p class="text-muted mb-md">Protect your app with a PIN/password (optional)</p>
                <div class="form-group">
                    <input type="password" id="setup-password" class="form-input"
                        placeholder="Enter password (leave empty to skip)">
                </div>
                <div class="form-group">
                    <input type="password" id="setup-password-confirm" class="form-input"
                        placeholder="Confirm password">
                </div>
                <div class="settings-row" style="margin-top: var(--space-md);">
                    <div>
                        <div class="settings-label">Auto-Lock</div>
                        <div class="settings-description">Lock app after inactivity</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="setup-auto-lock">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="form-group" style="margin-top: var(--space-sm);">
                    <label class="form-label">Lock after</label>
                    <select id="setup-auto-lock-delay" class="form-select">
                        <option value="5">5 minutes</option>
                        <option value="10">10 minutes</option>
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                    </select>
                </div>
            </div>

            <!-- Step 4: Notifications -->
            <div class="setup-content hidden" id="setup-step-4">
                <h4>üîî Notifications</h4>
                <p class="text-muted mb-md">Get notifications about downloads (optional)</p>

                <div class="settings-row" style="margin-bottom: var(--space-md);">
                    <div>
                        <div class="settings-label">Enable Notifications</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="setup-notifications-enabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <h5 style="margin-bottom: var(--space-sm); color: var(--text-secondary);">Telegram Bot</h5>
                <div class="form-group">
                    <label class="form-label">Bot Token</label>
                    <input type="text" id="setup-telegram-token" class="form-input" placeholder="123456789:ABC...">
                </div>
                <div class="form-group">
                    <label class="form-label">Chat ID</label>
                    <input type="text" id="setup-telegram-chat" class="form-input" placeholder="Your chat ID">
                </div>

                <h5 style="margin-bottom: var(--space-sm); color: var(--text-secondary);">Discord Webhook</h5>
                <div class="form-group">
                    <label class="form-label">Webhook URL</label>
                    <input type="text" id="setup-discord-webhook" class="form-input"
                        placeholder="https://discord.com/api/webhooks/...">
                </div>
            </div>

            <!-- Step 5: Scheduler -->
            <div class="setup-content hidden" id="setup-step-5">
                <h4>‚è∞ Auto-Sync Schedule</h4>
                <p class="text-muted mb-md">Automatically sync all users on a schedule (optional)</p>
                <div class="settings-row" style="margin-bottom: var(--space-md);">
                    <div>
                        <div class="settings-label">Enable Scheduler</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="setup-scheduler-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Sync Time</label>
                    <input type="time" id="setup-scheduler-time" class="form-input" value="03:00">
                </div>
            </div>

            <!-- Step 6: Instagram Cookie -->
            <div class="setup-content hidden" id="setup-step-6">
                <h4>üç™ Instagram Cookies</h4>
                <p class="text-muted mb-md">Upload cookies.txt to download from Instagram (optional)</p>
                <div class="upload-zone" onclick="document.getElementById('setup-cookie-upload').click()">
                    <div class="upload-zone-icon">üì§</div>
                    <p>Click to upload cookies.txt</p>
                    <input type="file" id="setup-cookie-upload" accept=".txt" style="display:none"
                        onchange="setupCookieSelected(event)">
                </div>
                <p id="setup-cookie-status" class="text-muted mt-sm"></p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="setup-prev-btn" onclick="setupPrevStep()"
                style="display:none">Back</button>
            <button type="button" class="btn btn-secondary" onclick="skipSetup()">Skip All</button>
            <button type="button" class="btn btn-primary" id="setup-next-btn" onclick="setupNextStep()">Next</button>
        </div>
    </div>

    <style>
        .setup-steps {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .setup-step {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }

        .setup-step.active {
            background: var(--accent-primary);
            color: white;
        }

        .setup-step.completed {
            background: var(--accent-success);
            color: white;
        }

        .setup-content {
            min-height: 200px;
        }

        .setup-content h4 {
            margin-bottom: var(--space-sm);
        }
    </style>

    <!-- Media Viewer Modal -->
    <div id="media-viewer-modal" class="modal modal-xl">
        <button class="modal-close-viewer" onclick="closeMediaViewer()">‚úï</button>
        <div class="media-viewer-content">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script src="/static/app.js?v={{ range(1000000) | random }}"></script>
</body>

</html>